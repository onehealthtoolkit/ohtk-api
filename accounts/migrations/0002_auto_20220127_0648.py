# Generated by Django 4.0.1 on 2022-01-27 06:48

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ("accounts", "0001_initial"),
    ]

    operations = [
        migrations.RunSQL(
            """
create or replace function inherit_authority_up(src_id bigint)
    returns table
            (
                id bigint
            )
as
$$
with RECURSIVE cte as (
    select id, 0 as depth, ARRAY [id] as path
    from accounts_authority
    where id = src_id

    union all

    select a.id, depth + 1, a.id || path
    from accounts_authority a,
         accounts_authority_inherits aih,
         cte
    where a.id = aih.to_authority_id
      and aih.from_authority_id = cte.id
      and not path @> Array [a.id]
)
select distinct id
from cte;

$$ language sql stable;
            """,
            """
drop function inherit_authority_up(src_id bigint);
            """,
        )
    ]
